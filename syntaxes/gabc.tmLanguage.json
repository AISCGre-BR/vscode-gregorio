{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "GABC",
  "scopeName": "source.gabc",
  "fileTypes": ["gabc"],
  "patterns": [
    { "include": "#header" },
    { "include": "#section-separator" },
    { "include": "#syllable-text" },
    { "include": "#note-group" }
  ],
  "repository": {
    "header": {
      "patterns": [
        { "include": "#header-numeric" },
        { "include": "#header-tex" },
        { "include": "#header-generic" }
      ]
    },
    "header-numeric": {
      "patterns": [
        {
          "comment": "mode: numeric value (1-8 or Roman numerals)",
          "name": "meta.header.numeric.mode.gabc",
          "begin": "^(mode)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "patterns": [
            {
              "comment": "Numbers in mode value",
              "name": "constant.numeric.gabc",
              "match": "\\d+"
            },
            {
              "comment": "Roman numerals",
              "name": "constant.numeric.gabc",
              "match": "\\b[IVX]+\\b"
            },
            {
              "name": "string.unquoted.gabc",
              "match": "[^;\\n]+"
            }
          ]
        },
        {
          "comment": "staff-lines: numeric value",
          "name": "meta.header.numeric.staff-lines.gabc",
          "begin": "^(staff-lines)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "contentName": "constant.numeric.gabc"
        },
        {
          "comment": "nabc-lines: numeric value",
          "name": "meta.header.numeric.nabc-lines.gabc",
          "begin": "^(nabc-lines)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "contentName": "constant.numeric.gabc"
        }
      ]
    },
    "header-tex": {
      "patterns": [
        {
          "comment": "annotation: LaTeX code",
          "name": "meta.header.tex.annotation.gabc",
          "begin": "^(annotation)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "patterns": [
            { "include": "text.tex.latex" }
          ]
        },
        {
          "comment": "mode-modifier: LaTeX code",
          "name": "meta.header.tex.mode-modifier.gabc",
          "begin": "^(mode-modifier)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "patterns": [
            { "include": "text.tex.latex" }
          ]
        },
        {
          "comment": "mode-differentia: LaTeX code",
          "name": "meta.header.tex.mode-differentia.gabc",
          "begin": "^(mode-differentia)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "patterns": [
            { "include": "text.tex.latex" }
          ]
        },
        {
          "comment": "def-m0 through def-m9: LaTeX macro definitions",
          "name": "meta.header.tex.def-macro.gabc",
          "begin": "^(def-m[0-9])\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "patterns": [
            { "include": "text.tex.latex" }
          ]
        }
      ]
    },
    "header-generic": {
      "patterns": [
        {
          "comment": "Generic headers with string values",
          "name": "meta.header.generic.gabc",
          "begin": "^([a-zA-Z][a-zA-Z0-9_-]*)\\s*(:)\\s*",
          "beginCaptures": {
            "1": { "name": "entity.name.tag.gabc" },
            "2": { "name": "punctuation.separator.gabc" }
          },
          "end": ";;|;|$",
          "endCaptures": {
            "0": { "name": "punctuation.terminator.gabc" }
          },
          "contentName": "string.unquoted.gabc"
        }
      ]
    },
    "section-separator": {
      "name": "keyword.control.separator.gabc",
      "match": "^%%$"
    },
    "syllable-text": {
      "patterns": [
        { "include": "#syllable-style" },
        { "include": "#syllable-special" }
      ]
    },
    "syllable-style": {
      "patterns": [
        {
          "name": "markup.bold.gabc",
          "begin": "<b>",
          "end": "</b>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "markup.italic.gabc",
          "begin": "<i>",
          "end": "</i>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "markup.underline.gabc",
          "begin": "<ul>",
          "end": "</ul>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "markup.heading.gabc",
          "begin": "<sc>",
          "end": "</sc>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "markup.raw.gabc",
          "begin": "<tt>",
          "end": "</tt>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "markup.underline.link.gabc",
          "begin": "<c>",
          "end": "</c>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        }
      ]
    },
    "syllable-special": {
      "patterns": [
        {
          "name": "string.other.verbatim.gabc",
          "begin": "<v>",
          "end": "</v>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "string.other.above-lines.gabc",
          "begin": "<alt>",
          "end": "</alt>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        },
        {
          "name": "string.other.special-char.gabc",
          "begin": "<sp>",
          "end": "</sp>",
          "captures": { "0": { "name": "punctuation.definition.tag.gabc" } }
        }
      ]
    },
    "note-group": {
      "name": "meta.note-group.gabc",
      "begin": "\\(",
      "end": "\\)",
      "beginCaptures": { "0": { "name": "punctuation.section.group.begin.gabc" } },
      "endCaptures": { "0": { "name": "punctuation.section.group.end.gabc" } },
      "patterns": [
        { "include": "#clef" },
        { "include": "#nabc-section" },
        { "include": "#gabc-content" }
      ]
    },
    "gabc-content": {
      "patterns": [
        { "include": "#clef-linking" },
        { "include": "#custos" },
        { "include": "#line-break" },
        { "include": "#fusion-bracket" },
        { "include": "#initio-debilis" },
        { "include": "#pitch-with-modifiers" },
        { "include": "#bar" },
        { "include": "#spacing" },
        { "include": "#rhythmic-sign" },
        { "include": "#extra-symbols" },
        { "include": "#attribute" }
      ]
    },
    "nabc-section": {
      "name": "meta.nabc-section.gabc",
      "begin": "\\|",
      "end": "(?=\\||\\))",
      "beginCaptures": { "0": { "name": "keyword.operator.nabc-separator.gabc" } },
      "patterns": [
        { "include": "#nabc-content" }
      ]
    },
    "nabc-content": {
      "patterns": [
        { "include": "#nabc-spacing" },
        { "include": "#nabc-fusion" },
        { "include": "#nabc-subpunctis-prepunctis" },
        { "include": "#nabc-basic-glyphs" },
        { "include": "#nabc-modifiers" }
      ]
    },
    "nabc-spacing": {
      "patterns": [
        {
          "comment": "NABC spacing codes: /, //, `, ``",
          "name": "keyword.other.unit.gabc",
          "match": "//|``|/|`"
        }
      ]
    },
    "nabc-fusion": {
      "patterns": [
        {
          "comment": "NABC glyph fusion with ! operator",
          "match": "(vi|pu|ta|gr|cl|pe|to|pr|sc|cm|un|sa|ob|tr|qu|vr)(!)",
          "captures": {
            "1": { "name": "keyword.control.gabc" },
            "2": { "name": "keyword.operator.gabc" }
          }
        }
      ]
    },
    "nabc-basic-glyphs": {
      "patterns": [
        {
          "comment": "NABC basic 2-letter glyphs",
          "name": "keyword.control.gabc",
          "match": "\\b(vi|pu|ta|gr|cl|pe|to|pr|sc|cm|un|sa|ob|tr|qu|vr)\\b"
        }
      ]
    },
    "nabc-subpunctis-prepunctis": {
      "patterns": [
        {
          "comment": "Subpunctis and prepunctis with numbers",
          "match": "(pp|su)(\\d+)",
          "captures": {
            "1": { "name": "variable.language.gabc" },
            "2": { "name": "constant.numeric.gabc" }
          }
        }
      ]
    },
    "nabc-modifiers": {
      "patterns": [
        {
          "comment": "NABC modifiers with optional variant numbers",
          "match": "([SGM\\->~])(\\d*)",
          "captures": {
            "1": { "name": "variable.other.gabc" },
            "2": { "name": "constant.numeric.gabc" }
          }
        }
      ]
    },
    "clef": {
      "patterns": [
        {
          "comment": "Simple clef without linking",
          "name": "keyword.control.gabc",
          "match": "\\b([cf])(b)?([1-4])\\b"
        }
      ]
    },
    "clef-linking": {
      "patterns": [
        {
          "comment": "Clef linking with @ operator (c2@c4)",
          "match": "\\b([cf])(b)?([1-4])(@)([cf])(b)?([1-4])\\b",
          "captures": {
            "1": { "name": "keyword.control.gabc" },
            "2": { "name": "keyword.control.gabc" },
            "3": { "name": "keyword.control.gabc" },
            "4": { "name": "keyword.operator.gabc" },
            "5": { "name": "keyword.control.gabc" },
            "6": { "name": "keyword.control.gabc" },
            "7": { "name": "keyword.control.gabc" }
          }
        }
      ]
    },
    "custos": {
      "patterns": [
        {
          "comment": "Custos: z0, Z0, or pitch followed by +",
          "name": "variable.other.gabc",
          "match": "[zZ]0|[a-npA-NP]\\+"
        }
      ]
    },
    "line-break": {
      "patterns": [
        {
          "comment": "Line break with modifier (z+, z-, Z+, Z-)",
          "match": "([zZ])([+-])",
          "captures": {
            "1": { "name": "constant.character.escape.gabc" },
            "2": { "name": "keyword.operator.gabc" }
          }
        },
        {
          "comment": "Simple line break (z, Z) - not followed by 0 or +/-",
          "name": "constant.character.escape.gabc",
          "match": "[zZ](?![0+-])"
        }
      ]
    },
    "fusion-bracket": {
      "patterns": [
        {
          "comment": "Fusion with bracket notation @[...]",
          "begin": "(@)(\\[)",
          "end": "\\]",
          "beginCaptures": {
            "1": { "name": "entity.name.function.gabc" },
            "2": { "name": "punctuation.definition.bracket.begin.gabc" }
          },
          "endCaptures": { "0": { "name": "punctuation.definition.bracket.end.gabc" } },
          "patterns": [
            { "include": "#pitch-with-modifiers" }
          ]
        }
      ]
    },
    "initio-debilis": {
      "patterns": [
        {
          "comment": "Initio debilis: -[pitch][leaning][alterations][shapes]",
          "name": "variable.other.constant.gabc",
          "match": "-([a-npA-NP])([012])?([xyXY#?]+)?([wvosqr=~<>O]+)?([01])?"
        }
      ]
    },
    "pitch-with-modifiers": {
      "patterns": [
        {
          "comment": "Pitch with alteration and/or shape, followed by @ fusion",
          "match": "([a-npA-NP])([012])?([xyXY#?]+)?([wvosqr=~<>O]+)?([01])?(@)",
          "captures": {
            "1": { "name": "variable.language.gabc" },
            "2": { "name": "variable.language.gabc" },
            "3": { "name": "string.regexp.gabc" },
            "4": { "name": "variable.other.constant.gabc" },
            "5": { "name": "variable.other.constant.gabc" },
            "6": { "name": "keyword.operator.gabc" }
          }
        },
        {
          "comment": "Pitch with alteration (priority over shape)",
          "name": "string.regexp.gabc",
          "match": "([a-npA-NP])([012])?([xyXY#?]+)([wvosqr=~<>O]+)?([01])?"
        },
        {
          "comment": "Pitch with shape only (no alteration)",
          "name": "variable.other.constant.gabc",
          "match": "([a-npA-NP])([012])?([wvosqr=~<>O]+)([01])?"
        },
        {
          "comment": "Plain pitch (no alteration or shape)",
          "name": "variable.language.gabc",
          "match": "[a-npA-NP]([012])?"
        }
      ]
    },
    "rhythmic-sign": {
      "patterns": [
        {
          "comment": "Rhythmic signs r1-r8",
          "name": "variable.other.gabc",
          "match": "r[1-8]"
        }
      ]
    },
    "extra-symbols": {
      "patterns": [
        {
          "comment": "Punctum mora, ictus, episema",
          "name": "variable.other.gabc",
          "match": "\\.|'|_|-"
        }
      ]
    },
    "alteration": {
      "patterns": [
        {
          "name": "constant.language.alteration.gabc",
          "match": "[xy#]|\\([xy#]\\)"
        }
      ]
    },

    "bar": {
      "patterns": [
        {
          "comment": "Double colon with question mark",
          "name": "keyword.control.gabc",
          "match": "::?"
        },
        {
          "comment": "Bars with ledger line indicator",
          "match": "([`,;:])([0-8])",
          "captures": {
            "1": { "name": "keyword.control.gabc" },
            "2": { "name": "constant.numeric.gabc" }
          }
        },
        {
          "comment": "Bars with question mark",
          "match": "(:)(\\?)",
          "captures": {
            "1": { "name": "keyword.control.gabc" },
            "2": { "name": "keyword.control.gabc" }
          }
        },
        {
          "comment": "Simple bars",
          "name": "keyword.control.gabc",
          "match": "[`,;:\\^]0?"
        }
      ]
    },
    "spacing": {
      "patterns": [
        {
          "comment": "Spacing with bracket [number]",
          "name": "keyword.other.unit.gabc",
          "match": "/\\[[^\\]]+\\]"
        },
        {
          "comment": "Double spacing codes",
          "name": "keyword.other.unit.gabc",
          "match": "//|!!"
        },
        {
          "comment": "Special spacing codes",
          "name": "keyword.other.unit.gabc",
          "match": "/[0!]"
        },
        {
          "comment": "Single spacing codes (but not @ which is handled by fusion)",
          "name": "keyword.other.unit.gabc",
          "match": "[!/](?!@)"
        },
        {
          "comment": "Standalone @ spacing code (not followed by [)",
          "name": "keyword.other.unit.gabc",
          "match": "@(?!\\[)"
        }
      ]
    },
    "attribute": {
      "patterns": [
        {
          "comment": "LaTeX verbatim attributes: nv (note), gv (glyph), ev (element)",
          "name": "meta.attribute.verbatim.gabc",
          "begin": "\\[(nv|gv|ev):",
          "end": "\\]",
          "beginCaptures": {
            "0": { "name": "punctuation.definition.attribute.begin.gabc" },
            "1": { "name": "entity.other.attribute-name.gabc" }
          },
          "endCaptures": { "0": { "name": "punctuation.definition.attribute.end.gabc" } },
          "patterns": [
            {
              "name": "meta.embedded.inline.latex",
              "contentName": "source.latex",
              "begin": "(?<=:)",
              "end": "(?=\\])",
              "patterns": [
                { "include": "text.tex.latex" }
              ]
            }
          ]
        },
        {
          "comment": "Above lines text attribute with LaTeX support",
          "name": "meta.attribute.alt.gabc",
          "begin": "\\[(alt):",
          "end": "\\]",
          "beginCaptures": {
            "0": { "name": "punctuation.definition.attribute.begin.gabc" },
            "1": { "name": "entity.other.attribute-name.gabc" }
          },
          "endCaptures": { "0": { "name": "punctuation.definition.attribute.end.gabc" } },
          "patterns": [
            {
              "name": "meta.embedded.inline.latex",
              "contentName": "source.latex",
              "begin": "(?<=:)",
              "end": "(?=\\])",
              "patterns": [
                { "include": "text.tex.latex" }
              ]
            }
          ]
        },
        {
          "comment": "Attributes with unbalanced braces: ob, ub, ocb, ocba, oll, ull, oslur, uslur, oh, uh",
          "name": "meta.attribute.braces.gabc",
          "begin": "\\[(ob|ub|ocb|ocba|oll|ull|oslur|uslur|oh|uh):",
          "end": "\\]",
          "beginCaptures": {
            "1": { "name": "entity.other.attribute-name.gabc" }
          },
          "contentName": "string.unquoted.attribute-value.gabc",
          "patterns": [
            {
              "comment": "Numbers in attribute values",
              "match": "\\d+(\\.\\d+)?",
              "name": "constant.numeric.gabc"
            },
            {
              "comment": "Semicolon separator",
              "match": ";",
              "name": "punctuation.separator.parameter.gabc"
            }
          ]
        },
        {
          "comment": "Generic attributes",
          "name": "meta.attribute.gabc",
          "begin": "\\[([a-z]+):",
          "end": "\\]",
          "beginCaptures": {
            "0": { "name": "punctuation.definition.attribute.begin.gabc" },
            "1": { "name": "entity.other.attribute-name.gabc" }
          },
          "endCaptures": { "0": { "name": "punctuation.definition.attribute.end.gabc" } },
          "contentName": "string.unquoted.attribute-value.gabc",
          "patterns": [
            {
              "comment": "Numbers in attribute values",
              "match": "\\d+(\\.\\d+)?",
              "name": "constant.numeric.gabc"
            },
            {
              "comment": "Semicolon separator",
              "match": ";",
              "name": "punctuation.separator.parameter.gabc"
            }
          ]
        },
        {
          "comment": "Attributes without values (e.g., nocustos)",
          "name": "meta.attribute.gabc",
          "match": "\\[([a-z]+)\\]",
          "captures": {
            "0": { "name": "punctuation.definition.attribute.gabc" },
            "1": { "name": "entity.other.attribute-name.gabc" }
          }
        }
      ]
    },
    "line-break": {
      "patterns": [
        {
          "name": "keyword.control.linebreak.gabc",
          "match": "z0?|Z0?"
        }
      ]
    }
  }
}
